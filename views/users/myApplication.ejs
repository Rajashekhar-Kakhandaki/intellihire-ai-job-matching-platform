<%- layout("layouts/boilerplate") %>

<body>

  <div class="container">
    
    <h2>My Job Applications</h2>

    <% if (applications.length === 0) { %>
      <p>You havenâ€™t applied to any jobs yet.</p>
    <% } else { %>

      <table class="applications-table">
        <thead>
          <tr>
            <th>Job Title</th>
            <th>Company</th>
            <th>Location</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody>
          <% applications.forEach(application => { 
            const statusClass = application.status
              ? application.status.toLowerCase().replace(/\s+/g, "-")
              : "unknown";

            const jobTitle = application.job
              ? application.job.title
              : "this job";
          %>

          <tr>
            <td><%= application.job ? application.job.title : "Job Deleted" %></td>
            <td><%= application.job ? application.job.companyName : "-" %></td>
            <td><%= application.job ? application.job.location : "-" %></td>

            <td>
              <span class="status-badge <%= statusClass %>">
                <%= application.status %>
              </span>
            </td>

            <td>
              <div class="action-box">

                <% if (application.status !== "Accepted") { %>
                  <form action="/application/withdraw/<%= application._id %>"
                        method="POST"
                        onsubmit="return confirm('Withdraw application for <%= jobTitle %>?')">
                    <button class="btn-withdraw">Withdraw</button>
                  </form>
                <% } else { %>
                  <span class="badge accepted">Accepted</span>
                <% } %>

                <% if (application.statusHistory && application.statusHistory.length > 1) { %>
                  <details class="timeline-box">
                    <summary>View Status History</summary>
                    <ul>
                      <% application.statusHistory.forEach(item => { %>
                        <li>
                          <span class="dot"></span>
                          <strong><%= item.status %></strong>
                          <small><%= item.date.toDateString() %></small>
                        </li>
                      <% }) %>
                    </ul>
                  </details>
                <% } %>

              </div>
            </td>
          </tr>

          <% }) %>
        </tbody>
      </table>

    <% } %>
  </div>
</body>
